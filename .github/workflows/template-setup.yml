name: Template Repository Setup

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest

    # ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã§ã®ã¿å®Ÿè¡Œã•ã‚Œã‚‹ã¹ããªã®ã§
    # ç‰¹å®šã®æ¡ä»¶ã§ã‚¹ã‚­ãƒƒãƒ—ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
    if: github.repository != 'tkgshn/X2Scb'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup repository for template use
        run: |
          echo "ğŸš€ Setting up repository from template..."

          # publicãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®æ—¢å­˜ã®ãƒ„ã‚¤ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
          echo "ğŸ§¹ Cleaning up sample data..."
          find public -name "*.json" -delete
          find public -name "*.txt" -delete
          find public -name "*.html" -delete

          # .gitkeepãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦publicãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä¿æŒ
          touch public/.gitkeep

          # ãƒªãƒã‚¸ãƒˆãƒªåã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
          REPO_NAME=$(echo $GITHUB_REPOSITORY | cut -d'/' -f2)
          USER_NAME=$(echo $GITHUB_REPOSITORY | cut -d'/' -f1)

          echo "ğŸ“ Updating UserScript configuration..."
          # UserScriptã®è¨­å®šã‚’å‹•çš„ã«æ›´æ–°
          sed -i "s/YOUR_GITHUB_USERNAME/$USER_NAME/g" src/frontend/userscript/scrapbox-twitter-daily.user.js
          sed -i "s/YOUR_REPO_NAME/$REPO_NAME/g" src/frontend/userscript/scrapbox-twitter-daily.user.js

          # ã‚µãƒ³ãƒ—ãƒ«ã®.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          echo "ğŸ“ Creating environment setup files..."
          cat > SETUP.md << 'EOF'
          # ğŸ”§ Initial Setup Required

          ## 1. Environment Variables

          Create a `.env` file in the root directory with the following variables:

          ```env
          TWITTER_USERNAME=your_twitter_username
          TWITTER_BEARER_TOKEN=your_twitter_bearer_token
          ```

          ## 2. GitHub Pages Setup

          1. Go to your repository settings
          2. Navigate to "Pages" section
          3. Enable GitHub Pages with source "GitHub Actions"

          ## 3. GitHub Actions Secrets

          Add the following secrets to your repository:
          - `TW_BEARER`: Your Twitter API Bearer Token
          - `OPENAI_API_KEY`: Your OpenAI API Key (for tweet summaries)
          - `SCRAPBOX_PROJECT`: Your Scrapbox project name
          - `TWITTER_USERNAME`: Your Twitter username

          ## 4. Customize Configuration

          The UserScript has been automatically configured with your GitHub username and repository name.
          You can verify this in: `src/frontend/userscript/scrapbox-twitter-daily.user.js`

          ## 5. First Run

          After setup, you can manually trigger the daily workflow or wait for the scheduled run.

          ---

          **Delete this file after completing the setup!**
          EOF

      - name: Update README for template use
        run: |
          echo "ğŸ“š Updating README..."
          cat > README.md << 'EOF'
          # ğŸ“± X2Scb - Twitter to Scrapbox Integration

          > ğŸš€ **This repository was created from a template. Please see [SETUP.md](SETUP.md) for initial configuration!**

          ## ğŸ“– Overview

          X2Scb automatically collects your daily tweets and formats them for easy import into Scrapbox pages.

          ## âœ¨ Features

          - ğŸ”„ **Automated Collection**: Daily GitHub Actions workflow collects your tweets
          - ğŸ“‹ **Scrapbox Format**: Converts tweets to Scrapbox-compatible format
          - ğŸŒ **GitHub Pages**: Hosts formatted data for easy access
          - ğŸ”§ **UserScript**: Browser extension for seamless Scrapbox integration
          - ğŸ“Š **Multiple Formats**: JSON and TXT output formats

          ## ğŸš€ Quick Start

          1. **Complete Initial Setup**: Follow instructions in [SETUP.md](SETUP.md)
          2. **Configure Environment**: Set up your Twitter API credentials
          3. **Enable GitHub Pages**: Configure Pages in repository settings
          4. **Install UserScript**: Add the browser script for Scrapbox integration

          ## ğŸ“ Directory Structure

          ```
          â”œâ”€â”€ .github/workflows/     # GitHub Actions workflows
          â”œâ”€â”€ public/               # Generated tweet data (GitHub Pages)
          â”œâ”€â”€ src/
          â”‚   â”œâ”€â”€ backend/          # Data processing scripts
          â”‚   â””â”€â”€ frontend/         # UserScript for Scrapbox
          â”œâ”€â”€ scripts/              # Utility scripts
          â””â”€â”€ daily.js              # Main collection script
          ```

          ## ğŸ› ï¸ Usage

          ### Automatic Collection
          The GitHub Actions workflow runs daily and:
          1. Fetches your previous day's tweets
          2. Formats them for Scrapbox
          3. Publishes to GitHub Pages

          ### Manual Import
          Use the UserScript in Scrapbox to:
          - Automatically import yesterday's tweets to date pages
          - Manually import specific dates with `?date=YYYY-MM-DD` parameter

          ## ğŸ”§ Configuration

          See [SETUP.md](SETUP.md) for detailed configuration instructions.

          ## ğŸ“„ License

          MIT License - feel free to use and modify!

          ## ğŸ¤ Contributing

          Issues and pull requests are welcome!
          EOF

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "ğŸ‰ Initialize repository from template

          - Clean up sample data from public directory
          - Add setup instructions (SETUP.md)
          - Update README for template usage
          - Update UserScript configuration automatically
          - Prepare for initial configuration" || exit 0

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main

      - name: Remove template setup workflow
        run: |
          echo "ğŸ—‘ï¸ Removing template setup workflow..."
          git rm .github/workflows/template-setup.yml
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git commit -m "ğŸ§¹ Remove template setup workflow after initialization"

      - name: Push cleanup
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main

      - name: Setup complete
        run: |
          echo "âœ… Template setup complete!"
          echo "ğŸ“‹ Next steps:"
          echo "1. Check the SETUP.md file for configuration instructions"
          echo "2. Set up your environment variables"
          echo "3. Configure GitHub Pages"
          echo "4. Add your Twitter API credentials to repository secrets"
